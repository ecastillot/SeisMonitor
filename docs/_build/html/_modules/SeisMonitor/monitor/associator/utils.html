

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SeisMonitor.monitor.associator.utils &mdash; SeisMonitor 0.0.57 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=2bfb35b6"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            SeisMonitor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">SeisMonitor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">SeisMonitor.monitor.associator.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SeisMonitor.monitor.associator.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">obspy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.core.inventory.inventory</span><span class="w"> </span><span class="kn">import</span> <span class="n">Inventory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.io.xseed.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.core.utcdatetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTCDateTime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SeisMonitor.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">printlog</span><span class="p">,</span> <span class="n">isfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Constants</span>
<span class="n">SEISMONITOR_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;pick_id&quot;</span><span class="p">,</span> <span class="s2">&quot;arrival_time&quot;</span><span class="p">,</span> <span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;phasehint&quot;</span><span class="p">,</span>
    <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;instrument_type&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span>
    <span class="s2">&quot;creation_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_end_time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detection_probability&quot;</span><span class="p">,</span> <span class="s2">&quot;snr&quot;</span><span class="p">,</span> <span class="s2">&quot;station_lat&quot;</span><span class="p">,</span> <span class="s2">&quot;station_lon&quot;</span><span class="p">,</span>
    <span class="s2">&quot;station_elv&quot;</span><span class="p">,</span> <span class="s2">&quot;file_name&quot;</span>
<span class="p">]</span>

<span class="n">EQT_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;instrument_type&quot;</span><span class="p">,</span>
    <span class="s2">&quot;station_lat&quot;</span><span class="p">,</span> <span class="s2">&quot;station_lon&quot;</span><span class="p">,</span> <span class="s2">&quot;station_elv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;event_start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_end_time&quot;</span><span class="p">,</span> <span class="s2">&quot;detection_probability&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detection_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;p_arrival_time&quot;</span><span class="p">,</span> <span class="s2">&quot;p_probability&quot;</span><span class="p">,</span>
    <span class="s2">&quot;p_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;p_snr&quot;</span><span class="p">,</span> <span class="s2">&quot;s_arrival_time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;s_probability&quot;</span><span class="p">,</span> <span class="s2">&quot;s_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;s_snr&quot;</span>
<span class="p">]</span>

<span class="n">GAMMA_PICKS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">,</span> <span class="s2">&quot;amp&quot;</span><span class="p">]</span>

<span class="n">PAZ_WA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sensitivity&#39;</span><span class="p">:</span> <span class="mi">2800</span><span class="p">,</span>
    <span class="s1">&#39;zeros&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="n">j</span><span class="p">],</span>
    <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;poles&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">6.2832</span> <span class="o">-</span> <span class="mf">4.7124</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2832</span> <span class="o">+</span> <span class="mf">4.7124</span><span class="n">j</span><span class="p">]</span>
<span class="p">}</span>


<div class="viewcode-block" id="get_picks_gamma_df">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.get_picks_gamma_df">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_picks_gamma_df</span><span class="p">(</span><span class="n">picks</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">compute_amplitudes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">s_window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">waterlevel</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert picks to GaMMA-compatible DataFrame format.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        picks (str): Path to picks CSV file</span>
<span class="sd">        response (Inventory or Parser): Station response information</span>
<span class="sd">        compute_amplitudes (bool): Whether to compute amplitudes</span>
<span class="sd">        p_window (int): P-wave window length in seconds</span>
<span class="sd">        s_window (int): S-wave window length in seconds</span>
<span class="sd">        waterlevel (int): Waterlevel for amplitude calculation</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: Formatted picks DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">picks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="s1">&#39;network&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                                   <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="s1">&#39;instrument_type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span> <span class="c1">#forcing string</span>
    <span class="n">date_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">,</span> <span class="s2">&quot;creation_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_end_time&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_loc</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert location code to two-digit string format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_loc</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">compute_amplitudes</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_seismonitor_amplitudes</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span>
            <span class="n">p_window</span><span class="o">=</span><span class="n">p_window</span><span class="p">,</span>
            <span class="n">s_window</span><span class="o">=</span><span class="n">s_window</span><span class="p">,</span>
            <span class="n">waterlevel</span><span class="o">=</span><span class="n">waterlevel</span>
        <span class="p">)</span>

    <span class="n">id_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pick_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">id_func</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;arrival_time&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="s2">&quot;prob&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phasehint&quot;</span><span class="p">:</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;amplitude&quot;</span><span class="p">:</span> <span class="s2">&quot;amp&quot;</span>
    <span class="p">})</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="get_stations_gamma_df">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.get_stations_gamma_df">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_stations_gamma_df</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert station response to GaMMA-compatible DataFrame format.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        response (Inventory): Station response inventory</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: Formatted stations DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">id_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">station_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">longitude_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">latitude_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">elevation_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">network</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">code</span>
            <span class="n">sta</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">code</span>
            <span class="n">elv</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">elevation</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">latitude</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">longitude</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">station</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">station</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">location_code</span>
            <span class="n">scr_id</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">net</span><span class="p">,</span> <span class="n">sta</span><span class="p">))</span>

            <span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scr_id</span><span class="p">)</span>
            <span class="n">station_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span>
            <span class="n">longitude_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">latitude_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">elevation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elv</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">id_list</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">longitude_list</span><span class="p">,</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">latitude_list</span><span class="p">,</span>
        <span class="s2">&quot;elevation(m)&quot;</span><span class="p">:</span> <span class="n">elevation_list</span><span class="p">,</span>
        <span class="s2">&quot;station_name&quot;</span><span class="p">:</span> <span class="n">station_list</span>
    <span class="p">})</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="get_paz_from_response">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.get_paz_from_response">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_paz_from_response</span><span class="p">(</span><span class="n">seed_id</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract Poles and Zeros (PAZ) information from response.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        seed_id (str): SEED identifier</span>
<span class="sd">        response (Inventory or Parser): Response information</span>
<span class="sd">        datetime (UTCDateTime, optional): Specific time for response</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: PAZ dictionary or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Parser</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">paz</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_paz</span><span class="p">(</span><span class="n">seed_id</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Inventory</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">seed_id</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
            <span class="n">paz_stage</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_paz</span><span class="p">()</span>
            <span class="n">paz</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;poles&#39;</span><span class="p">:</span> <span class="n">paz_stage</span><span class="o">.</span><span class="n">poles</span><span class="p">,</span>
                <span class="s1">&#39;zeros&#39;</span><span class="p">:</span> <span class="n">paz_stage</span><span class="o">.</span><span class="n">zeros</span><span class="p">,</span>
                <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="n">paz_stage</span><span class="o">.</span><span class="n">normalization_factor</span><span class="p">,</span>
                <span class="s1">&#39;sensitivity&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">instrument_sensitivity</span><span class="o">.</span><span class="n">value</span>
            <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">paz</span></div>



<div class="viewcode-block" id="get_amplitudes_from_pick">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.get_amplitudes_from_pick">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_amplitudes_from_pick</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">picktime</span><span class="p">,</span> <span class="n">phasehint</span><span class="p">,</span> <span class="n">p_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">s_window</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate amplitude from a seismic trace for a given pick.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        st (Stream): Obspy Stream object</span>
<span class="sd">        picktime (datetime): Pick time</span>
<span class="sd">        phasehint (str): Phase type (&#39;P&#39; or &#39;S&#39;)</span>
<span class="sd">        p_window (int): P-wave window length in seconds</span>
<span class="sd">        s_window (int): S-wave window length in seconds</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        float: Maximum amplitude value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">phasehint</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
        <span class="n">trimmedtime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">p_window</span><span class="p">)</span>
        <span class="n">_st</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">picktime</span><span class="p">),</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">picktime</span><span class="p">)</span> <span class="o">+</span> <span class="n">trimmedtime</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">_st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">&quot;Z&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ampl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">phasehint</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
        <span class="n">trimmedtime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">s_window</span><span class="p">)</span>
        <span class="n">_st</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">picktime</span><span class="p">),</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">picktime</span><span class="p">)</span> <span class="o">+</span> <span class="n">trimmedtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tr_n</span> <span class="o">=</span> <span class="n">_st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr_e</span> <span class="o">=</span> <span class="n">_st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ampl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tr_n</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tr_e</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ampl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ampl</span></div>



<div class="viewcode-block" id="get_amplitudes_from_local_st">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.get_amplitudes_from_local_st">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_amplitudes_from_local_st</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">p_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">s_window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">waterlevel</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate amplitudes from local seismic data file.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        file_name (str): Path to seismic data file</span>
<span class="sd">        df (pandas.DataFrame): Picks DataFrame</span>
<span class="sd">        response (Inventory or Parser): Response information</span>
<span class="sd">        p_window (int): P-wave window length in seconds</span>
<span class="sd">        s_window (int): S-wave window length in seconds</span>
<span class="sd">        waterlevel (int): Waterlevel for simulation</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: DataFrame with added amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
        <span class="n">paz</span> <span class="o">=</span> <span class="n">get_paz_from_response</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">paz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">-&gt;No response found: </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">paz_remove</span><span class="o">=</span><span class="n">paz</span><span class="p">,</span> <span class="n">paz_simulate</span><span class="o">=</span><span class="n">PAZ_WA</span><span class="p">,</span> <span class="n">water_level</span><span class="o">=</span><span class="n">waterlevel</span><span class="p">)</span>

    <span class="n">ampl_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_amplitudes_from_pick</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">arrival_time</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">phasehint</span><span class="p">,</span> <span class="n">p_window</span><span class="p">,</span> <span class="n">s_window</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ampl_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="get_seismonitor_amplitudes">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.get_seismonitor_amplitudes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_seismonitor_amplitudes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">s_window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">waterlevel</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add amplitude calculations to SeisMonitor picks.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): Input picks DataFrame</span>
<span class="sd">        response (Inventory or Parser): Response information</span>
<span class="sd">        out (str, optional): Output CSV file path</span>
<span class="sd">        p_window (int): P-wave window length in seconds</span>
<span class="sd">        s_window (int): S-wave window length in seconds</span>
<span class="sd">        waterlevel (int): Waterlevel for simulation</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: DataFrame with amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">,</span> <span class="s2">&quot;creation_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_end_time&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_amplitudes_from_local_st</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">p_window</span><span class="p">,</span> <span class="n">s_window</span><span class="p">,</span> <span class="n">waterlevel</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()]</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="n">fourth_column</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="n">fourth_column</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">isfile</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="link">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.link">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="n">p_row</span><span class="p">,</span> <span class="n">s_df</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Link P and S phases for a given pick.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        p_row (pandas.Series): P pick row</span>
<span class="sd">        s_df (pandas.DataFrame): S picks DataFrame</span>
<span class="sd">        tt (float): Time threshold in seconds</span>
<span class="sd">        st (float): Start time offset in seconds</span>
<span class="sd">        et (float): End time offset in seconds</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.Series: Updated pick row with linked phases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_time</span> <span class="o">=</span> <span class="n">p_row</span><span class="o">.</span><span class="n">arrival_time</span>
    <span class="n">s_minus_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_time</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">][</span><span class="nb">abs</span><span class="p">(</span><span class="n">s_minus_p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tt</span><span class="p">]</span>
    <span class="n">s_df</span> <span class="o">=</span> <span class="n">s_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p_row</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s2">&quot;s_arrival_time&quot;</span><span class="p">:</span> <span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;s_probability&quot;</span><span class="p">:</span> <span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;s_pick_id&quot;</span><span class="p">:</span> <span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;pick_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;event_start_time&#39;</span><span class="p">:</span> <span class="n">p_time</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">st</span><span class="p">),</span>
            <span class="s1">&#39;event_end_time&#39;</span><span class="p">:</span> <span class="n">p_time</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">et</span><span class="p">),</span>
            <span class="s1">&#39;detection_probability&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_row</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">s_df</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_row</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s2">&quot;s_arrival_time&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;s_probability&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;s_pick_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;event_start_time&#39;</span><span class="p">:</span> <span class="n">p_time</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">st</span><span class="p">),</span>
            <span class="s1">&#39;event_end_time&#39;</span><span class="p">:</span> <span class="n">p_time</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">et</span><span class="p">),</span>
            <span class="s1">&#39;detection_probability&#39;</span><span class="p">:</span> <span class="n">p_row</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">})</span>
    
    <span class="n">p_row</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">p_row</span><span class="o">.</span><span class="n">mseed_name</span><span class="p">,</span>
        <span class="s1">&#39;station_lat&#39;</span><span class="p">:</span> <span class="n">p_row</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span>
        <span class="s1">&#39;station_lon&#39;</span><span class="p">:</span> <span class="n">p_row</span><span class="o">.</span><span class="n">station_lon</span><span class="p">,</span>
        <span class="s1">&#39;station_elv&#39;</span><span class="p">:</span> <span class="n">p_row</span><span class="o">.</span><span class="n">station_elv</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">p_row</span></div>



<div class="viewcode-block" id="make_eqt_dirs">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.make_eqt_dirs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_eqt_dirs</span><span class="p">(</span><span class="n">eqt_df</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create EQTransformer-style directory structure and files.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        eqt_df (pandas.DataFrame): EQTransformer formatted DataFrame</span>
<span class="sd">        folder (str): Output directory path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dfbystation</span> <span class="o">=</span> <span class="n">eqt_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfbystation</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">():</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_outputs&quot;</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s2">&quot;X_prediction_results.csv&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="link_seismonitor_phases">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.link_seismonitor_phases">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">link_seismonitor_phases</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Link P and S phases in SeisMonitor format.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): SeisMonitor picks DataFrame</span>
<span class="sd">        tt (float): Time threshold in seconds for S pick search</span>
<span class="sd">        st (float): Start time offset in seconds</span>
<span class="sd">        et (float): End time offset in seconds</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: EQTransformer formatted DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;pick_id&quot;</span><span class="p">,</span> <span class="s2">&quot;arrival_time&quot;</span><span class="p">,</span> <span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s1">&#39;phasehint&#39;</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">,</span>
        <span class="s1">&#39;station&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;instrument_type&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span>
        <span class="s2">&quot;station_lat&quot;</span><span class="p">,</span> <span class="s2">&quot;station_lon&quot;</span><span class="p">,</span> <span class="s2">&quot;station_elv&quot;</span><span class="p">,</span>
        <span class="s1">&#39;creation_time&#39;</span><span class="p">,</span> <span class="s2">&quot;mseed_name&quot;</span>
    <span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">])</span>
    <span class="n">dfbystation</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">])</span>

    <span class="n">eqt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfbystation</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">():</span>
        <span class="n">p_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;phasehint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span>
        <span class="n">s_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;phasehint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">p_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">p_row</span> <span class="o">=</span> <span class="n">link</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">s_df</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">)</span>
            <span class="n">eqt_df</span> <span class="o">=</span> <span class="n">eqt_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">eqt_df</span> <span class="o">=</span> <span class="n">eqt_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">p_snr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">p_uncertainty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_snr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_uncertainty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detection_uncertainty</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;arrival_time&quot;</span><span class="p">:</span> <span class="s2">&quot;p_arrival_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="s2">&quot;p_probability&quot;</span>
    <span class="p">})[</span><span class="n">EQT_COLUMNS</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">eqt_df</span></div>



<div class="viewcode-block" id="link_eqt_phases">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.link_eqt_phases">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">link_eqt_phases</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Link P and S phases in EQTransformer format.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): Input picks DataFrame</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: EQTransformer formatted DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eqt_and_seismonitor_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;instrument_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;station_lat&quot;</span><span class="p">,</span> <span class="s2">&quot;station_lon&quot;</span><span class="p">,</span> <span class="s2">&quot;station_elv&quot;</span><span class="p">,</span> <span class="s2">&quot;event_start_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;event_end_time&quot;</span><span class="p">,</span> <span class="s2">&quot;detection_probability&quot;</span>
    <span class="p">]</span>
    <span class="n">p_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;phasehint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span>
    <span class="n">s_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;phasehint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">p_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">s_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">eqt_and_seismonitor_cols</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_p&quot;</span><span class="p">,</span> <span class="s2">&quot;_s&quot;</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">p_uncertainty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_uncertainty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detection_uncertainty</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;pick_id_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_pick_id&quot;</span><span class="p">,</span> <span class="s1">&#39;arrival_time_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_arrival_time&quot;</span><span class="p">,</span>
        <span class="s1">&#39;probability_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_probability&quot;</span><span class="p">,</span> <span class="s1">&#39;phasehint_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_phasehint&quot;</span><span class="p">,</span>
        <span class="s1">&#39;location_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_location&quot;</span><span class="p">,</span> <span class="s1">&#39;author_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_author&quot;</span><span class="p">,</span>
        <span class="s1">&#39;creation_time_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_creation_time&quot;</span><span class="p">,</span> <span class="s1">&#39;snr_p&#39;</span><span class="p">:</span> <span class="s2">&quot;p_snr&quot;</span><span class="p">,</span>
        <span class="s1">&#39;pick_id_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_pick_id&quot;</span><span class="p">,</span> <span class="s1">&#39;arrival_time_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_arrival_time&quot;</span><span class="p">,</span>
        <span class="s1">&#39;probability_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_probability&quot;</span><span class="p">,</span> <span class="s1">&#39;phasehint_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_phasehint&quot;</span><span class="p">,</span>
        <span class="s1">&#39;location_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_location&quot;</span><span class="p">,</span> <span class="s1">&#39;author_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_location&quot;</span><span class="p">,</span>
        <span class="s1">&#39;creation_time_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_creation_time&quot;</span><span class="p">,</span> <span class="s1">&#39;snr_s&#39;</span><span class="p">:</span> <span class="s2">&quot;s_snr&quot;</span>
    <span class="p">})[</span><span class="n">EQT_COLUMNS</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="seismonitor_picks_to_eqt_fmt">
<a class="viewcode-back" href="../../../../SeisMonitor.monitor.associator.html#SeisMonitor.monitor.associator.utils.seismonitor_picks_to_eqt_fmt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">seismonitor_picks_to_eqt_fmt</span><span class="p">(</span><span class="n">seismonitor_picks</span><span class="p">,</span> <span class="n">eqt_folder</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert SeisMonitor picks to EQTransformer format.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        seismonitor_picks (str): Path to SeisMonitor picks CSV</span>
<span class="sd">        eqt_folder (str): Output directory for EQTransformer files</span>
<span class="sd">        tt (float): Time threshold in seconds</span>
<span class="sd">        st (float): Start time offset in seconds</span>
<span class="sd">        et (float): End time offset in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">seismonitor_picks</span><span class="p">)</span>
    <span class="n">date_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;arrival_time&quot;</span><span class="p">,</span> <span class="s2">&quot;creation_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_end_time&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;author&quot;</span><span class="p">)</span>
    <span class="n">eqts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">author</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">():</span>
        <span class="n">eqt</span> <span class="o">=</span> <span class="n">link_eqt_phases</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">if</span> <span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;EQTransformer&quot;</span> <span class="k">else</span> <span class="n">link_seismonitor_phases</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">)</span>
        <span class="n">eqts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eqt</span><span class="p">)</span>
    
    <span class="n">eqt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">eqts</span><span class="p">)</span>
    <span class="n">make_eqt_dirs</span><span class="p">(</span><span class="n">eqt</span><span class="p">,</span> <span class="n">eqt_folder</span><span class="p">)</span>
    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;pnet_to_eqt_fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Emmanuel Castillo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>